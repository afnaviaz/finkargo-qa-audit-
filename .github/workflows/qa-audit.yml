name: QA Audit
on:
  workflow_dispatch:
    inputs:
      pais:
        description: "Pa√≠s a auditar"
        required: true
        default: "CO"
        type: choice
        options:
          - CO
          - MX
          - ALL
      ambiente:
        description: "Ambiente"
        required: true
        default: "Testing"
        type: choice
        options:
          - Testing
          - Staging
jobs:
  run-audit:
    runs-on: self-hosted
    steps:
      # --- PASO 1: CLONADO MANUAL Y REPARACI√ìN DE ESTRUCTURA ---
      - name: Manual Clean Checkout
        run: |
          echo "üßπ Limpiando workspace de forma absoluta..."
          find . -mindepth 1 -delete
          
          echo "üì• Clonando repositorio (Rama: main)..."
          git clone --depth 1 --single-branch --branch main https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git .
          
          echo "üìç Ubicaci√≥n actual: $(pwd)"
          echo "üìÇ Verificando archivos descargados:"
          ls -R

      # --- PASO 2: EJECUCI√ìN DEL SCRIPT ---
      - name: Run QA Audit
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          CONF_USER: ${{ secrets.CONF_USER }}
          CONF_TOKEN: ${{ secrets.CONF_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "üìÇ Entrando a la carpeta scripts..."
          cd scripts
          
          echo "üìÑ Archivos encontrados en scripts/:"
          ls -F
          
          SCRIPT_TO_RUN=$(ls run_env.sh run_all.sh 2>/dev/null | head -n 1)
          
          if [ -f "$SCRIPT_TO_RUN" ]; then
            echo "üöÄ Ejecutando: $SCRIPT_TO_RUN"
            chmod +x "$SCRIPT_TO_RUN"
            ./"$SCRIPT_TO_RUN" ${{ github.event.inputs.pais }} ${{ github.event.inputs.ambiente }}
          else
            echo "‚ùå ERROR: No se encontr√≥ run_env.sh ni run_all.sh dentro de la carpeta scripts/."
            exit 1
          fi

      # --- PASO 3: AN√ÅLISIS DE CAUSA RA√çZ CON CLAUDE ---
      - name: An√°lisis de Causa Ra√≠z con Claude
        if: always()
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üîç Buscando archivos de resultados..."

          RESULTS_FILE=$(find . -name "results_*.json" | head -n 1)
          LOG_FILE=$(find . -name "log_*.txt" | head -n 1)

          if [ -z "$RESULTS_FILE" ] && [ -z "$LOG_FILE" ]; then
            echo "‚ö†Ô∏è No se encontraron archivos de resultados."
            exit 0
          fi

          echo "üìÑ Resultados: $RESULTS_FILE"
          echo "üìÑ Log: $LOG_FILE"

          # Script Python que hace todo: lee archivos, llama API, parsea respuesta
          python3 << 'PYEOF'
          import json, os, subprocess, sys

          api_key = os.environ.get("ANTHROPIC_API_KEY", "")
          pais = "${{ github.event.inputs.pais }}"
          ambiente = "${{ github.event.inputs.ambiente }}"

          # Leer archivos
          content_parts = []

          results_file = "$RESULTS_FILE"
          log_file = "$LOG_FILE"

          if results_file and os.path.isfile(results_file):
              with open(results_file, "r", errors="replace") as f:
                  content_parts.append("RESULTADOS JSON:\n" + f.read()[:6000])

          if log_file and os.path.isfile(log_file):
              with open(log_file, "r", errors="replace") as f:
                  lines = f.readlines()
                  content_parts.append("LOG (√∫ltimas 150 l√≠neas):\n" + "".join(lines[-150:]))

          content = "\n\n".join(content_parts)

          prompt = f"""Eres un experto en QA de APIs REST. Analiza los resultados de pruebas automatizadas para el pa√≠s {pais} en ambiente {ambiente}.

          Proporciona:
          1. ‚úÖ Resumen ejecutivo (pruebas pasadas vs fallidas)
          2. üî¥ Causa ra√≠z de cada fallo encontrado
          3. üìä Patrones o tendencias de error
          4. üîß Recomendaciones concretas de correcci√≥n
          5. üö® Nivel de riesgo general (Alto/Medio/Bajo)

          Resultados:
          {content}"""

          body = json.dumps({
              "model": "claude-opus-4-6",
              "max_tokens": 2048,
              "messages": [{"role": "user", "content": prompt}]
          })

          # Llamar a la API
          result = subprocess.run([
              "curl", "-s",
              "https://api.anthropic.com/v1/messages",
              "-H", f"x-api-key: {api_key}",
              "-H", "anthropic-version: 2023-06-01",
              "-H", "content-type: application/json",
              "-d", body
          ], capture_output=True, text=True)

          print(f"HTTP raw response length: {len(result.stdout)}")

          try:
              data = json.loads(result.stdout)
          except Exception as e:
              print(f"‚ùå Error parseando JSON: {e}")
              print(f"Respuesta: {result.stdout[:500]}")
              sys.exit(1)

          if "error" in data:
              analysis = f"‚ùå Error de API: {data['error'].get('message', str(data['error']))}"
          elif "content" in data:
              analysis = data["content"][0]["text"]
          else:
              analysis = f"‚ùå Respuesta inesperada: {str(data)[:500]}"

          # Escribir Job Summary
          summary_file = os.environ.get("GITHUB_STEP_SUMMARY", "/dev/null")
          with open(summary_file, "a") as f:
              f.write("## ü§ñ An√°lisis de Causa Ra√≠z - Claude AI\n")
              f.write(f"**Pa√≠s:** {pais} | **Ambiente:** {ambiente}\n\n")
              f.write(analysis + "\n")

          # Guardar archivo
          os.makedirs("reports", exist_ok=True)
          with open("reports/claude-analysis.md", "w") as f:
              f.write(f"# An√°lisis de Causa Ra√≠z - Claude AI\n")
              f.write(f"**Pa√≠s:** {pais} | **Ambiente:** {ambiente}\n\n")
              f.write(analysis + "\n")

          print("‚úÖ An√°lisis completado y guardado.")
          PYEOF

      # --- PASO 4: SUBIDA DE ARTEFACTOS ---
      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-report-${{ github.event.inputs.pais }}-${{ github.event.inputs.ambiente }}
          path: |
            **/report_*.html
            **/results_*.json
            **/log_*.txt
            **/claude-analysis.md
          retention-days: 30
